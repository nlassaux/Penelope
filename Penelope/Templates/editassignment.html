{% extends "base_log.html" %}
{% load url from future %}
{% block title %}Edit assignment{% endblock %}

{% block breadcrumb %}

	<ul class="breadcrumb">
		<li>>> <a href="/">Dashboard</a><span class="divider">/</span></li>
		<li><a href="/{{editedassignment.course.id}}/details/">{{editedassignment.course.name}}</a><span class="divider">/</span></li>
		<li><a href="/assignments/{{editedassignment.id}}/details/">{{editedassignment.name}}</a><span class="divider">/</span></li>
		<li class="active">Edit</li>
	</ul>

{% endblock %}


{% block content %}

	<h1>Edit assignment</h1>
	<hr>
	<div class='span4 panel'>
		<h2>Informations</h2>
		<form class="centered-text" method="post">{% csrf_token %}
			<dl class="dl-horizontal">
				<dt><label for="id_name"><strong>Name :</strong></label></dt>
				<dl>{{ form.name }}{{ form.name.errors }}</dl>
				<dt><label for="id_description"><strong>Description :</strong></label></dt>
				<dl>{{ form.description }}</dl>
				<dt><label for="id_official_deadline"><strong>Official deadline :</strong></label></dt>
				<dl>{{ form.official_deadline }}</dl>
				<dt><label for="id_firm_deadline"><strong>Firm deadline :</strong></label></dt>
				<dl>{{ form.firm_deadline }}</dl>
				<dt><label for="id_admins"><strong>Admins :</strong></label></dt>
				<dl>{{ form.admins }}</dl>
				<dt><label for="id_method"><strong>Method :</strong></label></dt>
				<dl>{{ form.method }}</dl>
				<dt><label for="id_visible"><strong>Visible :</strong></label></dt>
				<dl>{{ form.visible }}</dl>
				<dt><input type="submit" value="Submit" class='btn btn-primary'/></dt>
			</dl>
		</form>
	</div>


	<div class='panel span6'>
		<h2>Required files management</h2>
		<form id='ajax_form' name='ajax_form' method="post" action='/works/{{editedassignment.id}}/addrequirement/' >{% csrf_token %}
			<input type="text" id='assignment_id' value='{{editedassignment.id}}' name='assignment_id' style="display: none;"/>
			<input type="text" id='requiredfilesnb' name='requiredfilesnb' style="display: none;" />
			<input type="submit" id='savebtn' value="Save" class='btn'/>
			<a id='addfilebtn' class='btn'>Add a requirement</a>
		</form>
		<p style='color: #46a546;' id='response'></p>
	</div>

{% endblock %}

{% block scripts %}
	<script type="text/javascript">

		// These lines are executed when the document has been loaded
		$('#addfilebtn').click(function(){
			addrequiredfile('','','','');
		});
		$('#requiredfilesnb').val($(".requiredfile").length);
		$('#id_method').change(change_text);
		change_text();

		// An ajax request to load requiredFilesFields
		$.ajax({
				type: "GET",
				url: "/works/" + $('#assignment_id').val() + "/addrequirement/",
				data: {assignment_id:$('#assignment_id').val()},
				success: function(xml) {
					loadrequiredfiles(xml);
				}
		});

		// Apply effects when we change value of method select
		function change_text() {
			if ($('#id_method').val() == 'free') {
				$('#ajax_form').hide();
			} else {
				$('#ajax_form').show();
			}
		};

		// Read XML response to build an edit form
		function loadrequiredfiles(xml) {
			test = $(xml).find('object').each(function(){
				var id = $(this).attr('pk');
				var name = $(this).find("field[name='name']").text();
				var description = $(this).find("field[name='description']").text();
				var type = $(this).find("field[name='type']").text();
				addrequiredfile(id, name, description, type);
				$('#requiredfilesnb').val($(".requiredfile").length);
			});
		}


		// *****************************************************
		//
		//									Add required file function
		//
		// *****************************************************

		// Add an empty form with : id, name, description and type fields. Hide id field
		function addrequiredfile(id, name, description, type) {
			// the id and name of all fields is dynamically set with that value
			var nextid = $(".requiredfile").length + 1;

			addrequiredfileclass('#ajax_form');
			addidfield('.requiredfile:last', id, nextid);
			addnamefield('.requiredfile:last', name, nextid);
			adddescriptionfield('.requiredfile:last', description, nextid);
			addtypefield('.requiredfile:last', type, nextid);

			// set to 'requiredfilenb' field the number of required file as value to be used after POST send
			$('#requiredfilesnb').val($(".requiredfile").length);
		};

		// create new <div class='requiredfile'></div> in a parent
		function addrequiredfileclass(parent){
			$(parent).append("<div class='requiredfile under_panel'></div>");
		};

		// return an id field with a value (content), and an index(index) to add to parent
		function addidfield(parent, content, index){
			var idfield = "<input type='text' value='" + content + "' id='requiredfileid" + index + "' name='requiredfileid" + index + "' style='display: none;''/>";
			$(parent).append(idfield);
		};

		// return a name field with a value (content), and an index(index) to add to parent
		function addnamefield(parent, content, index){
			var namefield = "<label>Name :</label><input type='text' value='" + content + "' name='requiredfilename" + index + "'/>";
			$(parent).append(namefield);
		};

		// return a description field with a value (content), and an index(index) to add to parent
		function adddescriptionfield(parent, content, index){
			var descriptionfield = "<label>Description :</label><textarea class='input-xlarge' name='requiredfiledescription" + index + "' rows='3'>" + content + "</textarea>";
			$(parent).append(descriptionfield);
		};

		// return a type field with a value (content), and an index(index) to add to parent
		function addtypefield(parent, content, index){
			var typefield = "<label>Type :</label><select name='requiredfiletype" + index + "'><option value='none'>none</option><option value='tar.gz'>tar.gz</option><option value='pdf'>pdf</option></select>";
			$(parent).append(typefield);
			$('select:last').val(content);

		};

	</script>
{% endblock %}